// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("MONGODB_URI")
}

// --------------------------------------------------
// Enums
// --------------------------------------------------

enum UserRole {
  CUSTOMER
  STAFF
  ADMIN
}

enum ProductCategory {
  CLADS
  SERVICES
  ACCESSORIES
}

enum ServiceType {
  WEBSITE_CREATION
  FULLSTACK_DEVELOPMENT
  MPESA_INTEGRATION
  MOBILE_APP
  CUSTOM_SOFTWARE
}

enum OrderStatus {
  PENDING
  PAID
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentMethod {
  MPESA
  CARD
  CASH
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
}

// --------------------------------------------------
// Models
// --------------------------------------------------

model User {
  id                String      @id @default(auto()) @map("_id") @db.ObjectId
  email             String      @unique
  password          String?     // Optional for OAuth users
  name              String
  role              UserRole    @default(CUSTOMER)
  googleId          String?     @unique @default("")
// Optional for standard registration

  avatar            String?
  phone             String?
  address           Address?    // Embedded document
  isEmailVerified   Boolean     @default(false)
  
  // Relations
  carts             Cart[]
  orders            Order[]
  createdProducts   Product[] @relation("CreatedProducts")
  
  // Timestamps
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  // ðŸ”‘ FIX FOR P2002 ERROR: 
  // This ensures 'googleId' is only unique for non-null values.
  // This allows multiple users without a googleId (standard registration).
  // The 'map' name is usually auto-generated by Prisma for unique fields.
 // @@unique([googleId], name: "users_googleId_key", map: "users_googleId_key") 
  
  @@map("users")
}

// Embedded Document Type for Address
type Address {
  street  String?
  city    String?
  state   String?
  zipCode String?
  country String  @default("Kenya")
}

model Product {
  id            String          @id @default(auto()) @map("_id") @db.ObjectId
  name          String
  description   String
  category      ProductCategory
  serviceType   ServiceType?    // Only for SERVICES category
  price         Float
  
  // Arrays (non-optional, can be empty [])
  images        String[]        // At least one image required (validate in code)
  stock         Int             // Use -1 for unlimited (services)
  sizes         String[]        // Empty [] for services
  colors        String[]        // Empty [] for services
  
  isActive      Boolean         @default(true)
  featured      Boolean         @default(false)
  metadata      Json?           // Flexible additional data
  
  // Relations
  createdBy     User            @relation("CreatedProducts", fields: [createdById], references: [id], onDelete: Cascade)
  createdById   String          @db.ObjectId
  
  // Timestamps
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  
  @@map("products")
}

model Cart {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  
  // One-to-one relation (enforced by @@unique([userId]))
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId        String    @db.ObjectId
  
  items         CartItem[] // Embedded array
  totalAmount   Float     @default(0)
  
  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Ensure one cart per user
  @@unique([userId])
  @@map("carts")
}

// Embedded Document Type for Cart Items
type CartItem {
  productId String  @db.ObjectId  // Reference to Product._id
  quantity  Int                  // Must be >= 1
  size      String?              // Optional - only for clothing
  color     String?              // Optional - only for clothing
  price     Float                // Price at time of adding to cart
}

model Order {
  id                  String          @id @default(auto()) @map("_id") @db.ObjectId
  orderNumber         String          @unique  // Unique order identifier (INF-2024-00001)
  
  // Relations
  user                User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId              String          @db.ObjectId
  
  // Embedded order details
  items               CartItem[]      // Snapshot from cart at time of order
  totalAmount         Float
  shippingAddress     Address         // Required for physical products
  notes               String?         // Customer notes
  trackingNumber      String?         // Shipping tracking number
  
  // Status and Payment
  status              OrderStatus     @default(PENDING)
  paymentMethod       PaymentMethod
  paymentStatus       PaymentStatus   @default(PENDING)
  transactionId       String?         // From payment provider
  
  // M-Pesa specific fields
  mpesaCheckoutId     String?         // STK Push request ID
  mpesaReceiptNumber  String?         // M-Pesa transaction receipt
  
  // Timestamps
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  deliveredAt         DateTime?       // When order was delivered
  
  // Indexes for query performance
  @@index([userId])
  @@index([status])
  @@index([paymentStatus])
  
  @@map("orders")
}