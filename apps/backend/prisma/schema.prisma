// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
  
  engineType = "library"
  output = "../node_modules/@prisma/client"
}

// NOTE: The 'url' is removed here because, as your comment suggests, 
// it's being loaded from prisma.config.ts or the .env file. This structure is correct for Prisma 7+.
datasource db {
  provider = "mongodb"
}

// --------------------------------------------------
// Enums
// --------------------------------------------------

enum UserRole {
  CUSTOMER
  STAFF
  ADMIN
}

enum ProductCategory {
  CLADS
  SERVICES
  ACCESSORIES
}

enum ServiceType {
  WEBSITE_CREATION
  FULLSTACK_DEVELOPMENT
  MPESA_INTEGRATION
  MOBILE_APP
  CUSTOM_SOFTWARE
}

enum OrderStatus {
  PENDING
  PAID
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentMethod {
  MPESA
  CARD
  CASH
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
}

// --------------------------------------------------
// Models
// --------------------------------------------------

model User {
  id                String    @id @default(auto()) @map("_id") @db.ObjectId
  email             String    @unique
  password          String?
  name              String
  role              UserRole  @default(CUSTOMER)
  googleId          String?   @unique
  avatar            String?
  phone             String?
  address           Address?
  isEmailVerified   Boolean   @default(false)
  
  // Relations
  carts             Cart[]
  orders            Order[]
  createdProducts   Product[] @relation("CreatedProducts")
  
  // Timestamps
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@map("users")
}

// Embedded Document Type for Address
type Address {
  street  String?
  city    String?
  state   String?
  zipCode String?
  country String  @default("Kenya")
}

model Product {
  id                String          @id @default(auto()) @map("_id") @db.ObjectId
  name              String
  description       String
  category          ProductCategory
  serviceType       ServiceType?
  price             Float
  
  // Arrays are correctly non-optional (String[])
  images            String[]
  stock             Int
  sizes             String[]
  colors            String[]
  
  isActive          Boolean         @default(true)
  featured          Boolean         @default(false)
  metadata          Json?
  
  // Relations
  createdBy         User            @relation("CreatedProducts", fields: [createdById], references: [id], onDelete: Cascade)
  createdById       String          @db.ObjectId
  
  // Timestamps
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  @@map("products")
}

model Cart {
  id                String    @id @default(auto()) @map("_id") @db.ObjectId
  
  // One-to-one relation enforced by @@unique([userId])
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId            String    @db.ObjectId
  
  items             CartItem[]
  totalAmount       Float     @default(0)
  
  // Timestamps
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Enforces a logical One-to-One relationship (one active cart per user)
  @@unique([userId]) 
  @@map("carts")
}

// Embedded Document Type for Cart Items
type CartItem {
  productId String  @db.ObjectId
  quantity  Int
  size      String?
  color     String?
  price     Float
}

model Order {
  id                String          @id @default(auto()) @map("_id") @db.ObjectId
  orderNumber       String          @unique // UNIQUE INDEX CREATED HERE - NO @@index needed
  
  // Relations
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId            String          @db.ObjectId
  
  // Embedded details
  items             CartItem[]
  totalAmount       Float
  shippingAddress   Address
  notes             String?
  trackingNumber    String?
  
  // Status and Payment
  status            OrderStatus     @default(PENDING)
  paymentMethod     PaymentMethod
  paymentStatus     PaymentStatus   @default(PENDING)
  transactionId     String?
  mpesaCheckoutId   String?
  mpesaReceiptNumber String?
  
  // Timestamps
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  deliveredAt       DateTime?
  
  // Indexes: Only explicitly create indexes for fields that are NOT @unique
  @@index([userId])
  @@index([status])
  @@index([paymentStatus])
  // REMOVED: @@index([orderNumber]) - This was redundant due to @unique above.
  
  @@map("orders")
}